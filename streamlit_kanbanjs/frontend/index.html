<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            font-family: sans-serif;
        }
        
        #board {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
            min-height: 700px;
        }
        
        .container {
            flex: 0 0 300px;
            border-radius: 10px;
            padding: 15px;
            min-height: 600px;
            transition: background-color 0.3s;
        }
        
        .container h3 {
            margin: 0 0 15px 0;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            text-align: center;
            position: sticky;
            top: 0;
            backdrop-filter: blur(5px);
        }
        
        .item-list {
            min-height: 500px;
        }
        
        .item {
            background: white;
            margin: 8px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .item:hover {
            background: #f8f9fa;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            transition: all 0.2s;
        }
        
        .item:active {
            cursor: grabbing;
            opacity: 0.8;
        }
        
        /* Pasek przewijania */
        #board::-webkit-scrollbar {
            height: 12px;
        }
        
        #board::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        #board::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }
        
        #board::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background: #c8ebfb;
            border: 2px dashed #3498db;
        }
        
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(2deg);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="board"></div>
    
    <script>
        // Funkcja inicjalizująca komponent
        function initKanban() {
            try {
                // Dane z Pythona
                const data = /* CONTAINERS_DATA */;
                const containersData = data.containers;
                const containerColors = data.colors;
                const componentKey = data.component_key || data.component_id || null;
                
                // Sprawdź czy dane są poprawne
                if (!containersData || !Array.isArray(containersData)) {
                    console.error('Brak danych kontenerów');
                    return;
                }
                
                // Wyczyść board przed ponownym generowaniem
                const board = document.getElementById('board');
                if (!board) {
                    console.error('Nie znaleziono elementu board');
                    return;
                }
                
                board.innerHTML = '';
                
                // Generowanie kontenerów
                containersData.forEach((container, i) => {
                    if (!container || !container.header) {
                        console.warn(`Pominięto kontener ${i} - brak nagłówka`);
                        return;
                    }
                    
                    const containerDiv = document.createElement('div');
                    containerDiv.className = 'container';
                    containerDiv.dataset.containerId = i;
                    containerDiv.style.backgroundColor = (containerColors && containerColors[i]) || '#f0f2f6';
                    
                    const header = document.createElement('h3');
                    header.textContent = container.header;
                    if (containerColors && containerColors[i]) {
                        header.style.background = `linear-gradient(135deg, ${containerColors[i]}dd, ${containerColors[i]}99)`;
                    }
                    
                    const itemList = document.createElement('div');
                    itemList.className = 'item-list';
                    itemList.id = `list-${i}`;
                    
                    // Dodawanie zadań
                    if (container.items && Array.isArray(container.items)) {
                        container.items.forEach(item => {
                            if (!item) return;
                            
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'item';
                            itemDiv.dataset.id = item.toString();
                            itemDiv.textContent = item.toString();
                            itemList.appendChild(itemDiv);
                        });
                    }
                    
                    containerDiv.appendChild(header);
                    containerDiv.appendChild(itemList);
                    board.appendChild(containerDiv);
                });
                
                // Sprawdź czy są jakieś listy do zainicjalizowania
                const lists = document.querySelectorAll('.item-list');
                if (lists.length === 0) {
                    console.warn('Brak list do inicjalizacji Sortable');
                    return;
                }
                
                // Inicjalizacja Sortable dla każdej listy
                const sortables = [];
                
                lists.forEach(list => {
                    try {
                        const sortable = new Sortable(list, {
                            group: 'shared',
                            animation: 200,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            handle: '.item',
                            
                            onEnd: function(evt) {
                                try {
                                    const resultData = {
                                        type: 'move',
                                        item: evt.item ? evt.item.dataset.id : null,
                                        from: evt.from ? evt.from.id : null,
                                        to: evt.to ? evt.to.id : null,
                                        oldIndex: evt.oldIndex,
                                        newIndex: evt.newIndex,
                                        containerFrom: evt.from ? evt.from.id.replace('list-', '') : null,
                                        containerTo: evt.to ? evt.to.id.replace('list-', '') : null
                                    };
                                    
                                    // Dodaj klucz komponentu jeśli istnieje
                                    if (componentKey) {
                                        resultData.key = componentKey;
                                    }
                                    
                                    if (window.Streamlit) {
                                        window.Streamlit.setComponentValue(resultData);
                                    }
                                } catch (e) {
                                    console.error('Błąd w onEnd:', e);
                                }
                            },
                            
                            onUpdate: function(evt) {
                                try {
                                    const resultData = {
                                        type: 'reorder',
                                        item: evt.item ? evt.item.dataset.id : null,
                                        container: evt.from ? evt.from.id : null,
                                        oldIndex: evt.oldIndex,
                                        newIndex: evt.newIndex
                                    };
                                    
                                    // Dodaj klucz komponentu jeśli istnieje
                                    if (componentKey) {
                                        resultData.key = componentKey;
                                    }
                                    
                                    if (window.Streamlit) {
                                        window.Streamlit.setComponentValue(resultData);
                                    }
                                } catch (e) {
                                    console.error('Błąd w onUpdate:', e);
                                }
                            }
                        });
                        
                        sortables.push(sortable);
                    } catch (e) {
                        console.error('Błąd inicjalizacji Sortable dla listy:', e);
                    }
                });
                
                console.log(`Zainicjalizowano ${sortables.length} list Sortable`);
                
            } catch (e) {
                console.error('Błąd inicjalizacji Kanban:', e);
            }
        }
        
        // Funkcja do wysyłania wysokości
        function sendHeight() {
            try {
                if (window.Streamlit) {
                    const height = document.body.scrollHeight;
                    window.Streamlit.setFrameHeight(height);
                }
            } catch (e) {
                console.error('Błąd wysyłania wysokości:', e);
            }
        }
        
        // Inicjalizacja po załadowaniu DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initKanban, 100);  // Małe opóźnienie dla pewności
                setTimeout(sendHeight, 200);
            });
        } else {
            setTimeout(initKanban, 100);
            setTimeout(sendHeight, 200);
        }
        
        // Obsługa zmiany rozmiaru
        window.addEventListener('resize', function() {
            setTimeout(sendHeight, 100);
        });
        
        // Obserwator zmian w DOM (na wypadek dynamicznych zmian)
        const observer = new MutationObserver(function(mutations) {
            setTimeout(sendHeight, 100);
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true
        });
        
        // Poinformuj Streamlit że komponent jest gotowy
        if (window.Streamlit) {
            try {
                window.Streamlit.setComponentReady();
            } catch (e) {
                console.error('Błąd setComponentReady:', e);
            }
        }
        
        // Dodatkowe zabezpieczenie - ponowna inicjalizacja po 1 sekundzie
        setTimeout(initKanban, 1000);
        setTimeout(sendHeight, 1100);
        
    </script>
</body>
</html>
